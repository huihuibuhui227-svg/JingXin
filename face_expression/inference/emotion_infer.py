"""
æƒ…ç»ªæŽ¨æ–­å¼•æ“Ž

åŸºäºŽé¢éƒ¨åŠ¨ä½œå•å…ƒï¼ˆAUï¼‰ç‰¹å¾è¿›è¡Œç²¾ç»†åŒ–æƒ…ç»ªåˆ¤åˆ«ï¼Œæ”¯æŒ 8 ç§åŸºæœ¬æƒ…ç»ªçŠ¶æ€ã€‚
é€‚ç”¨äºŽé™æ€å›¾åƒå’Œè§†é¢‘å¸§åˆ†æžã€‚
"""

from typing import Dict, Any


def infer_emotion_from_au(features: Dict[str, Any]) -> str:
    """
    åŸºäºŽ AU ç‰¹å¾è¿›è¡Œç²¾ç»†åŒ–æƒ…ç»ªåˆ¤åˆ«ï¼ˆé€‚ç”¨äºŽé™æ€å›¾åƒï¼‰

    Args:
        features (dict): åŒ…å« AU ç‰¹å¾çš„å­—å…¸ï¼Œåº”åŒ…å«ä»¥ä¸‹é”®ï¼ˆå¯é€‰ï¼‰ï¼š
            - 'au4_frown': float, çš±çœ‰å¼ºåº¦ (0.0~1.0)
            - 'au12_eyebrow_raise': float, çœ‰æ¯›ä¸Šæ‰¬ç¨‹åº¦
            - 'au12_smile': float, å¾®ç¬‘å¼ºåº¦
            - 'au9_nose_wrinkle': float, çš±é¼»ç¨‹åº¦
            - 'au15_mouth_down': float, å˜´è§’ä¸‹æ‹‰ç¨‹åº¦
            - 'au25_mouth_open': float, å¼ å˜´ç¨‹åº¦
            - 'focus_score': float, ä¸“æ³¨åº¦ (0.0~1.0)
            - 'blink_status': str, çœ¨çœ¼çŠ¶æ€ï¼ˆ'ççœ¼'/'é—­çœ¼'ï¼‰

    Returns:
        str: å¸¦ emoji çš„æƒ…ç»ªå­—ç¬¦ä¸²ï¼Œå¦‚ "æ„‰æ‚¦ ðŸ˜Š"

    Optimizations:
        - åŠ¨æ€é˜ˆå€¼ï¼ˆåŸºäºŽ AU åˆ†å¸ƒï¼‰
        - å¤š AU è”åˆé€»è¾‘
        - å¼•å…¥"ç½®ä¿¡åº¦"æ¦‚å¿µ
        - å¢žåŠ ä¸­æ€§/æ¨¡ç³ŠçŠ¶æ€å¤„ç†
    """
    # é˜²å¾¡æ€§ç¼–ç¨‹ï¼šç¡®ä¿ features ä¸ä¸º None
    if not features or not isinstance(features, dict):
        return "ä¸­æ€§ ðŸ˜"

    # æå–ç‰¹å¾ï¼ˆè®¾é»˜è®¤å€¼é˜² KeyErrorï¼‰
    au4 = float(features.get('au4_frown', 0.0))  # çš±çœ‰ï¼ˆçœ‰å¿ƒåŽ‹ä½Žï¼‰
    au12_raise = float(features.get('au12_eyebrow_raise', 0.0))  # çœ‰æ¯›ä¸Šæ‰¬
    au12_smile = float(features.get('au12_smile', 0.0))  # å¾®ç¬‘å¼ºåº¦ï¼ˆå˜´å®½/çœ¼è·ï¼‰
    au9 = float(features.get('au9_nose_wrinkle', 0.0))  # çš±é¼»
    au15 = float(features.get('au15_mouth_down', 0.0))  # å˜´è§’ä¸‹æ‹‰
    au25 = float(features.get('au25_mouth_open', 0.0))  # å¼ å˜´ç¨‹åº¦
    focus = float(features.get('focus_score', 0.5))  # ä¸“æ³¨åº¦ï¼ˆ0~1ï¼‰
    blink = features.get('blink_status', 'ççœ¼')  # é™æ€å›¾ä»…çŠ¶æ€

    # ==============================
    # Step 1: è®¡ç®—å„æƒ…ç»ªçš„"æ¿€æ´»åˆ†æ•°"
    # ==============================
    scores = {
        "æ„‰æ‚¦": 0.0,
        "ä¸“æ³¨": 0.0,
        "å›°æƒ‘": 0.0,
        "æƒŠè®¶": 0.0,
        "åŽŒæ¶": 0.0,
        "æ‚²ä¼¤": 0.0,
        "è¯´è¯": 0.0,
        "ä¸­æ€§": 0.0
    }

    # --- æ„‰æ‚¦ ðŸ˜Š ---
    if au12_smile > 0.8:
        scores["æ„‰æ‚¦"] += 0.7
        if au4 < 0.3:
            scores["æ„‰æ‚¦"] += 0.3  # æ— çš±çœ‰åŠ åˆ†

    # --- ä¸“æ³¨ ðŸ§  ---
    if au4 > 0.25:  # æ”¾å®½é˜ˆå€¼ï¼ˆåŽŸ 0.35 å¤ªé«˜ï¼‰
        if focus > 0.6:
            scores["ä¸“æ³¨"] += 0.6
        if au12_smile < 0.6:  # éžå¾®ç¬‘çŠ¶æ€
            scores["ä¸“æ³¨"] += 0.2
        if abs(au15) < 0.03:  # å˜´è§’æ— ä¸‹æ‹‰
            scores["ä¸“æ³¨"] += 0.2

    # --- å›°æƒ‘ â“ ---
    if au4 > 0.25:
        if focus < 0.55:  # æ”¾å®½ä¸“æ³¨åº¦é˜ˆå€¼
            scores["å›°æƒ‘"] += 0.7
        if au12_raise > 0.05:  # çœ‰æ¯›è½»å¾®ä¸Šæ‰¬ï¼ˆå›°æƒ‘å¸¸ä¼´éšï¼‰
            scores["å›°æƒ‘"] += 0.3

    # --- æƒŠè®¶ ðŸ˜® ---
    if au12_raise > 0.08:  # æ”¾å®½ï¼ˆåŽŸ 0.1ï¼‰
        if au25 > 0.12:  # æ”¾å®½ï¼ˆåŽŸ 0.15ï¼‰
            scores["æƒŠè®¶"] += 0.8
        if au4 < 0.2:  # æƒŠè®¶æ—¶é€šå¸¸ä¸çš±çœ‰
            scores["æƒŠè®¶"] += 0.2

    # --- åŽŒæ¶ ðŸ¤¢ ---
    if au9 > 0.25:  # æ”¾å®½ï¼ˆåŽŸ 0.3ï¼‰
        scores["åŽŒæ¶"] += 0.8
        if au4 > 0.2:  # åŽŒæ¶å¸¸ä¼´éšçš±çœ‰
            scores["åŽŒæ¶"] += 0.2

    # --- æ‚²ä¼¤ ðŸ˜¢ ---
    if au15 > 0.03:  # æ”¾å®½ï¼ˆåŽŸ 0.05ï¼‰
        scores["æ‚²ä¼¤"] += 0.7
        if au12_smile < 0.5:  # éžå¾®ç¬‘
            scores["æ‚²ä¼¤"] += 0.3
        if focus < 0.5:
            scores["æ‚²ä¼¤"] += 0.2

    # --- è¯´è¯ ðŸ’¬ ---
    if au25 > 0.18:  # æ”¾å®½ï¼ˆåŽŸ 0.2ï¼‰
        if au12_raise < 0.08:  # éžæƒŠè®¶çŠ¶æ€
            scores["è¯´è¯"] += 0.9

    # --- ä¸­æ€§ ðŸ˜ ---
    max_score = max(scores.values())
    if max_score < 0.5:  # æ— æ˜Žæ˜¾æƒ…ç»ªæ¿€æ´»
        scores["ä¸­æ€§"] = 1.0
    else:
        scores["ä¸­æ€§"] = 0.2  # é»˜è®¤ä½Žåˆ†

    # ==============================
    # Step 2: é€‰æ‹©æœ€é«˜åˆ†æƒ…ç»ª
    # ==============================
    emotion = max(scores, key=scores.get)
    max_score = scores[emotion]

    # ==============================
    # Step 3: ç‰¹æ®Šè§„åˆ™è¦†ç›–ï¼ˆé«˜ç½®ä¿¡åœºæ™¯ï¼‰
    # ==============================
    # è§„åˆ™1: å¼ºå¾®ç¬‘ + æ— çš±çœ‰ â†’ å¼ºåˆ¶æ„‰æ‚¦
    if au12_smile > 1.1 and au4 < 0.25:
        emotion = "æ„‰æ‚¦"
    # è§„åˆ™2: å¼ºçš±é¼» + çš±çœ‰ â†’ å¼ºåˆ¶åŽŒæ¶
    elif au9 > 0.35 and au4 > 0.3:
        emotion = "åŽŒæ¶"
    # è§„åˆ™3: å¼ºå˜´è§’ä¸‹æ‹‰ + ä½Žä¸“æ³¨ â†’ å¼ºåˆ¶æ‚²ä¼¤
    elif au15 > 0.08 and focus < 0.4:
        emotion = "æ‚²ä¼¤"

    # ==============================
    # Step 4: è¿”å›žå¸¦ emoji çš„å­—ç¬¦ä¸²
    # ==============================
    emoji_map = {
        "æ„‰æ‚¦": "ðŸ˜Š",
        "ä¸“æ³¨": "ðŸ§ ",
        "å›°æƒ‘": "â“",
        "æƒŠè®¶": "ðŸ˜®",
        "åŽŒæ¶": "ðŸ¤¢",
        "æ‚²ä¼¤": "ðŸ˜¢",
        "è¯´è¯": "ðŸ’¬",
        "ä¸­æ€§": "ðŸ˜"
    }
    return f"{emotion} {emoji_map[emotion]}"