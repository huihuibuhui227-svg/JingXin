"""
æƒ…ç»ªæ¨æ–­å¼•æ“ V2

åŸºäºé¢éƒ¨åŠ¨ä½œå•å…ƒï¼ˆAUï¼‰ç‰¹å¾è¿›è¡Œç²¾ç»†åŒ–æƒ…ç»ªåˆ¤åˆ«ï¼Œæ”¯æŒ 12 ç§æƒ…ç»ªçŠ¶æ€ã€‚
é€‚ç”¨äºé™æ€å›¾åƒå’Œè§†é¢‘å¸§åˆ†æã€‚
ä¼˜åŒ–äº†é˜ˆå€¼è®¾ç½®ï¼Œå¢åŠ äº†æ›´å¤šæƒ…ç»ªç±»å‹ã€‚
"""

from typing import Dict, Any


def infer_emotion_from_au(features: Dict[str, Any]) -> str:
    """
    åŸºäº AU ç‰¹å¾è¿›è¡Œç²¾ç»†åŒ–æƒ…ç»ªåˆ¤åˆ«ï¼ˆé€‚ç”¨äºé™æ€å›¾åƒå’Œè§†é¢‘å¸§åˆ†æï¼‰

    Args:
        features (dict): åŒ…å« AU ç‰¹å¾çš„å­—å…¸ï¼Œåº”åŒ…å«ä»¥ä¸‹é”®ï¼ˆå¯é€‰ï¼‰ï¼š
            - 'au4_frown': float, çš±çœ‰å¼ºåº¦ (0.0~1.0)
            - 'au12_eyebrow_raise': float, çœ‰æ¯›ä¸Šæ‰¬ç¨‹åº¦
            - 'au12_smile': float, å¾®ç¬‘å¼ºåº¦
            - 'au9_nose_wrinkle': float, çš±é¼»ç¨‹åº¦
            - 'au15_mouth_down': float, å˜´è§’ä¸‹æ‹‰ç¨‹åº¦
            - 'au25_mouth_open': float, å¼ å˜´ç¨‹åº¦
            - 'focus_score': float, ä¸“æ³¨åº¦ (0.0~1.0)
            - 'blink_rate_per_min': float, æ¯åˆ†é’Ÿçœ¨çœ¼æ¬¡æ•°
            - 'eye_closed_sec': float, çœ¼ç›é—­åˆæŒç»­æ—¶é—´ï¼ˆç§’ï¼‰

    Returns:
        str: å¸¦ emoji çš„æƒ…ç»ªå­—ç¬¦ä¸²ï¼Œå¦‚ "æ„‰æ‚¦ ğŸ˜Š"

    Optimizations:
        - åŠ¨æ€é˜ˆå€¼ï¼ˆåŸºäº AU åˆ†å¸ƒï¼‰
        - å¤š AU è”åˆé€»è¾‘
        - å¼•å…¥"ç½®ä¿¡åº¦"æ¦‚å¿µ
        - å¢åŠ ä¸­æ€§/æ¨¡ç³ŠçŠ¶æ€å¤„ç†
        - æ”¯æŒæ›´å¤šæƒ…ç»ªç±»å‹ï¼ˆ12ç§ï¼‰
    """
    # é˜²å¾¡æ€§ç¼–ç¨‹ï¼šç¡®ä¿ features ä¸ä¸º None
    if not features or not isinstance(features, dict):
        return "ä¸­æ€§ ğŸ˜"

    # æå–ç‰¹å¾ï¼ˆè®¾é»˜è®¤å€¼é˜² KeyErrorï¼‰
    au4 = float(features.get('au4_frown', 0.0))  # çš±çœ‰ï¼ˆçœ‰å¿ƒå‹ä½ï¼‰
    au12_raise = float(features.get('au12_eyebrow_raise', 0.0))  # çœ‰æ¯›ä¸Šæ‰¬
    au12_smile = float(features.get('au12_smile', 0.0))  # å¾®ç¬‘å¼ºåº¦ï¼ˆå˜´å®½/çœ¼è·ï¼‰
    au9 = float(features.get('au9_nose_wrinkle', 0.0))  # çš±é¼»
    au15 = float(features.get('au15_mouth_down', 0.0))  # å˜´è§’ä¸‹æ‹‰
    au25 = float(features.get('au25_mouth_open', 0.0))  # å¼ å˜´ç¨‹åº¦
    focus = float(features.get('focus_score', 0.5))  # ä¸“æ³¨åº¦ï¼ˆ0~1ï¼‰
    blink_rate = float(features.get('blink_rate_per_min', 15.0))  # çœ¨çœ¼é¢‘ç‡
    eye_closed = float(features.get('eye_closed_sec', 0.0))  # çœ¼ç›é—­åˆæ—¶é—´

    # ==============================
    # Step 1: è®¡ç®—å„æƒ…ç»ªçš„"æ¿€æ´»åˆ†æ•°"
    # ==============================
    scores = {
        "æ„‰æ‚¦": 0.0,
        "ä¸“æ³¨": 0.0,
        "å›°æƒ‘": 0.0,
        "æƒŠè®¶": 0.0,
        "åŒæ¶": 0.0,
        "æ‚²ä¼¤": 0.0,
        "æ„¤æ€’": 0.0,
        "ææƒ§": 0.0,
        "è½»è”‘": 0.0,
        "è¯´è¯": 0.0,
        "ç–²åŠ³": 0.0,
        "ä¸­æ€§": 0.0
    }

    # --- æ„‰æ‚¦ ğŸ˜Š ---
    # å¾®ç¬‘æ˜¯ä¸»è¦ç‰¹å¾ï¼Œä½†éœ€è¦æ’é™¤å…¶ä»–æƒ…ç»ªå¹²æ‰°
    if au12_smile > 0.6:  # é™ä½é˜ˆå€¼
        scores["æ„‰æ‚¦"] += 0.6
        if au4 < 0.25:  # æ— çš±çœ‰åŠ åˆ†
            scores["æ„‰æ‚¦"] += 0.3
        if au9 < 0.2:  # æ— çš±é¼»åŠ åˆ†
            scores["æ„‰æ‚¦"] += 0.1

    # --- ä¸“æ³¨ ğŸ§  ---
    # ä¸“æ³¨åº¦ + çš±çœ‰ + ç¨³å®šçš„è¡¨æƒ…
    if focus > 0.5:  # é™ä½é˜ˆå€¼
        scores["ä¸“æ³¨"] += 0.4
        if au4 > 0.15:  # è½»å¾®çš±çœ‰è¡¨ç¤ºæ€è€ƒ
            scores["ä¸“æ³¨"] += 0.3
        if abs(au15) < 0.05:  # å˜´è§’ç¨³å®š
            scores["ä¸“æ³¨"] += 0.2
        if au12_smile < 0.5:  # éå¾®ç¬‘çŠ¶æ€
            scores["ä¸“æ³¨"] += 0.1

    # --- å›°æƒ‘ â“ ---
    # çš±çœ‰ + çœ‰æ¯›ä¸Šæ‰¬ + ä½ä¸“æ³¨åº¦
    if au4 > 0.15:  # é™ä½é˜ˆå€¼
        scores["å›°æƒ‘"] += 0.3
        if au12_raise > 0.03:  # çœ‰æ¯›è½»å¾®ä¸Šæ‰¬
            scores["å›°æƒ‘"] += 0.4
        if focus < 0.6:  # ä½ä¸“æ³¨åº¦
            scores["å›°æƒ‘"] += 0.2
        if au12_smile < 0.4:  # éå¾®ç¬‘
            scores["å›°æƒ‘"] += 0.1

    # --- æƒŠè®¶ ğŸ˜® ---
    # çœ‰æ¯›ä¸Šæ‰¬ + å¼ å˜´ + æ— çš±çœ‰
    if au12_raise > 0.05:  # å¤§å¹…é™ä½é˜ˆå€¼
        scores["æƒŠè®¶"] += 0.4
        if au25 > 0.08:  # å¼ å˜´
            scores["æƒŠè®¶"] += 0.4
        if au4 < 0.25:  # æ— æ˜æ˜¾çš±çœ‰
            scores["æƒŠè®¶"] += 0.2

    # --- åŒæ¶ ğŸ¤¢ ---
    # çš±é¼» + çš±çœ‰ + å˜´è§’è½»å¾®ä¸Šæ‰¬æˆ–å¹³ç›´
    if au9 > 0.15:  # é™ä½é˜ˆå€¼
        scores["åŒæ¶"] += 0.5
        if au4 > 0.2:  # çš±çœ‰
            scores["åŒæ¶"] += 0.3
        if abs(au15) < 0.05:  # å˜´è§’ç¨³å®š
            scores["åŒæ¶"] += 0.2

    # --- æ‚²ä¼¤ ğŸ˜¢ ---
    # å˜´è§’ä¸‹æ‹‰ + ä½ä¸“æ³¨åº¦ + æ— å¾®ç¬‘
    if au15 > 0.02:  # å¤§å¹…é™ä½é˜ˆå€¼
        scores["æ‚²ä¼¤"] += 0.5
        if focus < 0.5:  # ä½ä¸“æ³¨åº¦
            scores["æ‚²ä¼¤"] += 0.3
        if au12_smile < 0.4:  # éå¾®ç¬‘
            scores["æ‚²ä¼¤"] += 0.2

    # --- æ„¤æ€’ ğŸ˜  ---
    # å¼ºçš±çœ‰ + çœ‰æ¯›ä¸‹å‹ + å˜´è§’ç´§é—­
    if au4 > 0.35:  # å¼ºçš±çœ‰
        scores["æ„¤æ€’"] += 0.5
        if au12_raise < 0.05:  # çœ‰æ¯›ä¸ä¸Šæ‰¬
            scores["æ„¤æ€’"] += 0.3
        if au25 < 0.1 and abs(au15) < 0.05:  # å˜´å·´ç´§é—­
            scores["æ„¤æ€’"] += 0.2

    # --- ææƒ§ ğŸ˜¨ ---
    # çœ‰æ¯›ä¸Šæ‰¬ + çœ¼ç›çå¤§ + å˜´è§’è½»å¾®ä¸‹æ‹‰
    if au12_raise > 0.06:
        scores["ææƒ§"] += 0.4
        if blink_rate < 10:  # çœ¨çœ¼å‡å°‘ï¼ˆçœ¼ç›çå¤§ï¼‰
            scores["ææƒ§"] += 0.3
        if au15 > 0.02:  # å˜´è§’è½»å¾®ä¸‹æ‹‰
            scores["ææƒ§"] += 0.2
        if au25 > 0.05:  # è½»å¾®å¼ å˜´
            scores["ææƒ§"] += 0.1

    # --- è½»è”‘ ğŸ˜ ---
    # ä¸€ä¾§å˜´è§’ä¸Šæ‰¬ + çœ‰æ¯›è½»å¾®ä¸Šæ‰¬
    if abs(au15) > 0.02:  # å˜´è§’ä¸å¯¹ç§°
        scores["è½»è”‘"] += 0.4
        if au12_raise > 0.03:  # çœ‰æ¯›è½»å¾®ä¸Šæ‰¬
            scores["è½»è”‘"] += 0.3
        if au4 < 0.25:  # æ— æ˜æ˜¾çš±çœ‰
            scores["è½»è”‘"] += 0.2
        if au12_smile > 0.3:  # è½»å¾®å¾®ç¬‘
            scores["è½»è”‘"] += 0.1

    # --- è¯´è¯ ğŸ’¬ ---
    # å¼ å˜´ + çœ‰æ¯›ç¨³å®š
    if au25 > 0.15:  # å¼ å˜´
        scores["è¯´è¯"] += 0.6
        if abs(au12_raise) < 0.1:  # çœ‰æ¯›ç¨³å®š
            scores["è¯´è¯"] += 0.3
        if au4 < 0.3:  # æ— æ˜æ˜¾çš±çœ‰
            scores["è¯´è¯"] += 0.1

    # --- ç–²åŠ³ ğŸ˜´ ---
    # é•¿æ—¶é—´é—­çœ¼ + ä½çœ¨çœ¼ç‡ + ä½ä¸“æ³¨åº¦
    if eye_closed > 0.5:  # çœ¼ç›é—­åˆè¶…è¿‡0.5ç§’
        scores["ç–²åŠ³"] += 0.6
        if blink_rate < 10:  # ä½çœ¨çœ¼ç‡
            scores["ç–²åŠ³"] += 0.2
        if focus < 0.5:  # ä½ä¸“æ³¨åº¦
            scores["ç–²åŠ³"] += 0.2

    # --- ä¸­æ€§ ğŸ˜ ---
    # æ‰€æœ‰AUç‰¹å¾éƒ½åœ¨æ­£å¸¸èŒƒå›´å†…
    max_score = max(scores.values())
    if max_score < 0.4:  # é™ä½é˜ˆå€¼
        scores["ä¸­æ€§"] = 1.0
    else:
        scores["ä¸­æ€§"] = 0.1  # é»˜è®¤ä½åˆ†

    # ==============================
    # Step 2: é€‰æ‹©æœ€é«˜åˆ†æƒ…ç»ª
    # ==============================
    emotion = max(scores, key=scores.get)
    max_score = scores[emotion]

    # ==============================
    # Step 3: ç‰¹æ®Šè§„åˆ™è¦†ç›–ï¼ˆé«˜ç½®ä¿¡åœºæ™¯ï¼‰
    # ==============================
    # è§„åˆ™1: å¼ºå¾®ç¬‘ + æ— çš±çœ‰ â†’ å¼ºåˆ¶æ„‰æ‚¦
    if au12_smile > 1.0 and au4 < 0.25:
        emotion = "æ„‰æ‚¦"
    # è§„åˆ™2: å¼ºçš±é¼» + çš±çœ‰ â†’ å¼ºåˆ¶åŒæ¶
    elif au9 > 0.3 and au4 > 0.3:
        emotion = "åŒæ¶"
    # è§„åˆ™3: å¼ºå˜´è§’ä¸‹æ‹‰ + ä½ä¸“æ³¨ â†’ å¼ºåˆ¶æ‚²ä¼¤
    elif au15 > 0.06 and focus < 0.4:
        emotion = "æ‚²ä¼¤"
    # è§„åˆ™4: å¼ºçš±çœ‰ + ç´§é—­å˜´ â†’ å¼ºåˆ¶æ„¤æ€’
    elif au4 > 0.4 and au25 < 0.08:
        emotion = "æ„¤æ€’"
    # è§„åˆ™5: é•¿æ—¶é—´é—­çœ¼ â†’ å¼ºåˆ¶ç–²åŠ³
    elif eye_closed > 1.0:
        emotion = "ç–²åŠ³"

    # ==============================
    # Step 4: è¿”å›å¸¦ emoji çš„å­—ç¬¦ä¸²
    # ==============================
    emoji_map = {
        "æ„‰æ‚¦": "ğŸ˜Š",
        "ä¸“æ³¨": "ğŸ§ ",
        "å›°æƒ‘": "â“",
        "æƒŠè®¶": "ğŸ˜®",
        "åŒæ¶": "ğŸ¤¢",
        "æ‚²ä¼¤": "ğŸ˜¢",
        "æ„¤æ€’": "ğŸ˜ ",
        "ææƒ§": "ğŸ˜¨",
        "è½»è”‘": "ğŸ˜",
        "è¯´è¯": "ğŸ’¬",
        "ç–²åŠ³": "ğŸ˜´",
        "ä¸­æ€§": "ğŸ˜"
    }
    return f"{emotion} {emoji_map[emotion]}"
